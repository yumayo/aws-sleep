services:

  ai:
    build:
      context: .
      dockerfile: docker/ai/Dockerfile
    tty: true
    stop_grace_period: 0s
    # iptablesでip制限を行うため
    cap_add:
        - NET_ADMIN
        - NET_RAW
    volumes:
      - ./:/app
      - type: tmpfs
        target: /app/.claude.local
        tmpfs:
          size: 0
      - type: tmpfs
        target: /app/env
        tmpfs:
          size: 0

      - type: bind
        source: .claude.local/.claude
        target: /home/ubuntu/.claude
        bind:
          create_host_path: false

      - type: bind
        source: .claude.local/.claude.json
        target: /home/ubuntu/.claude.json
        bind:
          create_host_path: false

  script:
    build:
      context: .
      dockerfile: docker/script/Dockerfile
    volumes:
      - ./:/app
    tty: true
    stop_grace_period: 0s

  web:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    volumes:
      - ./app/web:/app
    ports:
      - "5173:5173"
    user: ubuntu
    tty: true
    stop_grace_period: 0s

  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    volumes:
      - ./app/api:/app
    expose:
      - "5173"
      - "3000"
    env_file:
      - env/.env
    user: ubuntu
    tty: true
    stop_grace_period: 0s

    
