services:

  ai:
    build:
      context: .
      dockerfile: docker/ai/Dockerfile
    tty: true
    stop_grace_period: 0s
    # iptablesでip制限を行うため
    cap_add:
        - NET_ADMIN
        - NET_RAW
    volumes:
      - ./:/workspace
      - type: tmpfs
        target: /workspace/.claude.local
        tmpfs:
          size: 0
      - type: tmpfs
        target: /workspace/env
        tmpfs:
          size: 0

      - type: bind
        source: .claude.local/.claude
        target: /home/ubuntu/.claude
        bind:
          create_host_path: false

      - type: bind
        source: .claude.local/.claude.json
        target: /home/ubuntu/.claude.json
        bind:
          create_host_path: false

  script:
    build:
      context: .
      dockerfile: docker/script/Dockerfile
    volumes:
      - ./:/workspace
      - /var/run/docker.sock:/var/run/docker.sock  # ホストのDockerソケット
      - /var/lib/docker:/var/lib/docker            # イメージキャッシュ共有
    env_file:
      - env/script/.env
    tty: true
    stop_grace_period: 0s
    privileged: true

  web:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    volumes:
      - ./app/web:/workspace/app/web
      - ./app/lib:/workspace/app/lib
    expose:
      - "5173"
    user: ubuntu
    tty: true
    stop_grace_period: 0s

  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    volumes:
      - ./app/api:/workspace/app/api
      - ./app/lib:/workspace/app/lib
    expose:
      - "5173"
      - "3000"
    env_file:
      - env/api/.env
    user: ubuntu
    tty: true
    stop_grace_period: 0s

  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    ports:
      - "80:80"
